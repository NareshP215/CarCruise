<% layout("/layouts/boilerplate") -%>

<div class="row mt-3">
    <div class="col-8 offset-2">

        <h3>Create a New Listing </h3>

        <form method="post" action="/listings" novalidate
            class="needs-validation" enctype="multipart/form-data">

            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input name="listing[title]" placeholder="Add a catchy title"
                    type="text" class="form-control" required>
                <div class="valid-feedback">Title looks good!</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea name="listing[description]"
                    class="form-control" required></textarea>
                <div class="invalid-feedback">Please enter a short
                    description</div>
            </div>

            <div class="mb-3">
                <label for="image" class="form-label">Upload Listing
                    Image</label>
                <input name="listing[image]"
                    type="file" class="form-control" required>
            </div>

            <div class="row">
                <div class="mb-3 col-md-4">
                    <label for="price" class="form-label">Price</label>
                    <input name="listing[price]" placeholder="1200"
                        class="form-control" required>
                    <div class="invalid-feedback">Price should be valid</div>
                </div>

                <div class="mb-3 col-md-8">
                    <label for="country" class="form-label">Country</label>
                    <input name="listing[country]" id="country"
                        placeholder="India"
                        type="text" class="form-control" required>
                    <div class="invalid-feedback">Country name should be
                        valid</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="location" class="form-label">Location (City, State)</label>
                <input name="listing[location]" id="location"
                    placeholder="Jaipur, Rajasthan"
                    type="text" class="form-control" required>
                <div class="invalid-feedback">Location should be valid</div>
            </div>

            <!-- Hidden inputs for coordinates -->
            <input type="hidden" name="listing[latitude]" id="latitude">
            <input type="hidden" name="listing[longitude]" id="longitude">

            <div class="mb-3">
                <h3>Where you'll be</h3>
                <div class="map-container">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                    <div class="map-instructions">
                        <i class="fas fa-info-circle"></i> Drag the marker to set the exact location.
                    </div>
                </div>
            </div>

            <style>
                .tag-group { display:flex; flex-wrap: wrap; gap: .5rem; }
                .tag-pill { border-radius: 999px; }
            </style>
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between align-items-center">
                    <span>Categories</span>
                    <small class="text-muted"><span id="tagCount">0</span>/4 selected</small>
                </label>
                <div class="tag-group" aria-label="Category selection">
                    <% const availableTags = ['Premium','Luxurious','Budget','Family','SUV','Sedan','Hatchback','Electric','Manual','Automatic']; %>
                    <% availableTags.forEach(tag => { const id = `tag-${tag}`; %>
                        <input type="checkbox" class="btn-check tag-checkbox" name="listing[tags][]" value="<%= tag %>" id="<%= id %>" autocomplete="off">
                        <label class="btn btn-outline-dark btn-sm tag-pill" for="<%= id %>"><%= tag %></label>
                    <% }) %>
                </div>
                <small class="text-muted d-block mt-1">Choose up to 4 categories.</small>
            </div>

            <button class="btn btn-dark add-btn mt-3">Add</button>
        </form>
        <br>
    </div>
</div>

<script src="/js/listing-map.js"></script>
<script>
// Limit category selection to max 4 and show live count
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.tag-checkbox');
    const counterEl = document.getElementById('tagCount');
    const max = 4;
    const updateCount = () => {
        const count = Array.from(checkboxes).filter(c => c.checked).length;
        if (counterEl) counterEl.textContent = count.toString();
    };
    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const selected = Array.from(checkboxes).filter(c => c.checked);
            if (selected.length > max) {
                this.checked = false;
                return;
            }
            updateCount();
        });
    });
    updateCount();
});
</script>
